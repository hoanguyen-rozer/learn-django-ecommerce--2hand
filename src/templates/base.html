<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    
    <!-- Fontawesome-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>Base Template</title>
  </head>
  <body>
    {% include 'navbar.html' %}
    <div class="container">
      {% block content %}
          
      {% endblock content %}
    </div>
        

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    
    <script>
      $(document).ready(function(){
        var productForm = $(".form-product-ajax")

        productForm.submit(function(event){
          event.preventDefault();
          console.log("form is not sending")
          var thisForm = $(this)
          // var actionEndpoint = thisForm.attr("action");
          var actionEndpoint = thisForm.attr("data-endpoint");
          var httpMethod = thisForm.attr("method");
          var formData = thisForm.serialize();

          $.ajax({
            url: actionEndpoint,
            method: httpMethod,
            data: formData,
            success: function(data){
              // console.log("success")
              // console.log(data)
              // console.log(data.removed)
              var submitSpan = thisForm.find(".submit-span")
              if (data.added){
                submitSpan.html('In cart <button type="submit" class="btn btn-link mt-3">Remove?</button>')
              } else {
                submitSpan.html('<button type="submit" class="btn btn-primary mt-3">Add to cart</button>')
              }
              var navbarCount = $(".navbar-cart-count")
              navbarCount.text(data.cartItemCount)
              var currentPath = window.location.href

              if (currentPath.indexOf("cart") != 1){
                updateCart()
              }
            },

            error: function(errorData){
              console.log("error")
              console.log(errorData)
            }
          })

        })

        function updateCart(){
          console.log("in current cart")
          var cartTable = $(".cart-table")
          var cartBody = cartTable.find(".cart-body")
          var productRows = cartBody.find(".cart-product")
          var currentUrl = window.location.href

          var refreshCartUrl = '/api/cart'
          refreshCartMethond = 'GET'
          var data = {}

          $.ajax({
            url: refreshCartUrl,
            method: refreshCartMethond,
            data: data,
            success: function(data){
              var hiddenCartItemRemoveForm = $(".cart-item-remove-form")
              console.log("success")
              console.log(data)
              if (productRows.length > 0){
                productRows.html(" ")

                i = data.products.length
                $.each(data.products, function(index, value) {

                  console.log(value)
                  var newCartItemRemove = hiddenCartItemRemoveForm.clone()
                  newCartItemRemove.css("display", "block")
                  newCartItemRemove.find(".cart-item-product-id").val(value.id)
                  cartBody.prepend("<tr><th scope=\"row\">" + i + "</th><td><a href='" + value.url + "'>" + value.name + "</a>" + newCartItemRemove.html() + "</td><td>" + value.price + "</td></tr>")
                  i--
                } )
                
                cartBody.find(".cart-subtotal").text(data.subtotal)
                cartBody.find(".cart-total").text(data.total)
              } else {
                window.location.href = currentUrl
              }
              
            },
            error: function(errorData){
              console.log("error")
              console.log(errorData)
            }
          })          
        }
      })

    </script>
  
  
  </body>
</html>